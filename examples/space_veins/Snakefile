import os

configfile: "smk.config.yaml"

def get_tles_paths(wildcards):
    tles_fname_prefixes = config["tles_prefixes"]
    tles_fpaths = []
    tles_dir = config["tles_dir"]
    if tles_dir[-1] != "/":
        tles_dir += "/" 
    
    for fname in os.listdir(tles_dir):
        if fname.split("_")[0] in tles_fname_prefixes:
            tles_fpaths.append(f'{tles_dir + fname}')
    
    return tles_fpaths

def quote_strs(input):
    return [str('"' + tle_path + '"') for tle_path in input.tles_paths]

rule updateOmnetini:
    input:
        ini_path="omnetpp.ini.template",
        tles_paths=get_tles_paths
    params:
        # as snakemake won't accept filepath strings containing quotes as input
        quoted_tles_paths= lambda wildcards, input: quote_strs(input)
    output:
        "omnetpp.ini"
    shell:
        "python3 /workspaces/ma-max-wendler/scripts/keplertraces/updateomnetini.py {input.ini_path} ./traces/ {params.quoted_tles_paths}"